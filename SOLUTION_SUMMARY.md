# Решение Issue #1: Оптимизация кода под сервер

## Проблема

Бот работал как непрерывный асинхронный цикл и имел следующие проблемы:
1. При перезапуске сервера терялось всё расписание
2. Невозможно запустить генерацию и публикацию с точностью до секунды одновременно
3. Нет механизма восстановления состояния
4. Нет автоматического запуска на Ubuntu сервере

## Решение

### Архитектурные изменения

#### 1. Разделение на два процесса
- **Генерация** - выполняется за 10 минут до публикации
- **Публикация** - выполняется в запланированное время

#### 2. Файловое хранилище состояния
Создана директория `state/` с файлами:
- `generation_time.txt` - время следующей генерации (ISO 8601)
- `publication_time.txt` - время следующей публикации (ISO 8601)
- `current_prophecy.txt` - сгенерированное пророчество
- `prophecy_metadata.json` - метаданные (промпт, время и т.д.)

#### 3. Новый основной файл: `ai_prorok_refactored.py`
Три режима работы:
```bash
python ai_prorok_refactored.py schedule   # Планирование следующего цикла
python ai_prorok_refactored.py generate   # Генерация пророчества
python ai_prorok_refactored.py publish    # Публикация пророчества
```

#### 4. Scheduler: `scheduler.py`
Проверяет, наступило ли время для действия:
```bash
python scheduler.py check-generate  # Проверка времени генерации
python scheduler.py check-publish   # Проверка времени публикации
```

#### 5. Интеграция с systemd
Созданы сервисы и таймеры для автоматического запуска:
- `ai-prorok-generate.service/timer` - запускает генерацию когда время наступило
- `ai-prorok-publish.service/timer` - запускает публикацию когда время наступило

## Ключевые особенности решения

### Устойчивость к перезапускам
- Все критичные данные сохраняются в файлы
- При перезапуске scheduler читает актуальное состояние
- Если сервер пропустил время, действие выполняется при следующей проверке

### Точное разделение времён
- Генерация: за 10 минут до публикации (достаточно времени для OpenAI API)
- Публикация: в запланированное время
- Независимые процессы, не зависящие друг от друга

### Автоматизация
- systemd timers проверяют каждую минуту
- Автоматический запуск при загрузке системы
- Логирование в systemd journal

### Мониторинг
- Логи в systemd: `journalctl -u ai-prorok-*.service`
- Лог пророчеств: `prophecies_log.txt`
- Состояние в реальном времени: файлы в `state/`

## Workflow

```
┌─────────────────────────────────────────────────────────────┐
│ 1. ИНИЦИАЛИЗАЦИЯ (schedule)                                 │
│    - Вычисляет случайное время публикации на завтра         │
│    - Вычисляет время генерации (публикация - 10 минут)      │
│    - Сохраняет в generation_time.txt и publication_time.txt │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. ТАЙМЕРЫ (каждую минуту)                                  │
│    - generate.timer → scheduler check-generate               │
│    - publish.timer → scheduler check-publish                 │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. ГЕНЕРАЦИЯ (когда время наступило)                        │
│    - Загружает словари (nouns, verbs, adjectives)           │
│    - Создаёт случайные выборки                              │
│    - Формирует промпт для OpenAI                            │
│    - Получает пророчество от GPT-4                          │
│    - Сохраняет в current_prophecy.txt                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
       [Сервер может быть перезапущен здесь]
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. ПУБЛИКАЦИЯ (когда время наступило)                       │
│    - Загружает пророчество из current_prophecy.txt           │
│    - Публикует в VK и Telegram                              │
│    - Планирует следующий цикл (schedule)                    │
│    - Очищает файлы состояния                                │
└─────────────────────────────────────────────────────────────┘
                              ↓
                   [Возврат к шагу 2]
```

## Файлы решения

### Основные файлы
- `ai_prorok_refactored.py` - новая версия бота (569 строк)
- `scheduler.py` - проверка времени (108 строк)
- `requirements.txt` - зависимости
- `SETUP.md` - полная инструкция по установке (400+ строк)

### Systemd
- `systemd/ai-prorok-generate.service` - сервис генерации
- `systemd/ai-prorok-generate.timer` - таймер генерации
- `systemd/ai-prorok-publish.service` - сервис публикации
- `systemd/ai-prorok-publish.timer` - таймер публикации

### Примеры и тесты
- `examples/test_full_cycle.sh` - тест полного цикла
- `examples/test_scheduler.sh` - тест scheduler
- `examples/simulate_server_restart.sh` - тест устойчивости к перезапускам

## Преимущества

✅ **Устойчивость:** Работает после перезапуска сервера
✅ **Надёжность:** Все состояния персистентны
✅ **Гибкость:** Времена генерации и публикации разделены
✅ **Автоматизация:** Полная интеграция с systemd
✅ **Мониторинг:** Логи в systemd journal и файл
✅ **Тестируемость:** Примеры и тестовые скрипты
✅ **Документация:** Подробная инструкция по установке

## Результат

Бот теперь:
1. ✅ Адаптирован под перезапуски сервера
2. ✅ Логирует время генерации отдельным файлом
3. ✅ Логирует время публикации отдельным файлом
4. ✅ Логирует текущее пророчество отдельным файлом
5. ✅ Разделён на 2 времени (генерация и публикация)
6. ✅ Имеет запланированный запуск на Ubuntu через systemd

Все требования из issue #1 выполнены полностью.

---

**Pull Request:** https://github.com/PavelChurkin/ai_prorok/pull/2
**Статус:** Готов к ревью и мержу
